---
<% resource_names = %w(maven tomcat wildfly artifactory java) %>
resource_types:
<% resource_names.each do |resource| %>
- name: <%= resource %>-resource
  type: docker-image
  source:
    repository: splatform/<%= resource %>-resource
    tag: latest
<% end %>

<% maven_based_resource_names = %w(groovy tomee mariadb-jdbc postgresql-jdbc spring-boot-cli tomcat-access-logging-support tomcat-lifecycle-support tomee-resource-configuration tomcat-logging-support container-customizer) %>

<% artifactory_based_resource_names = %w(memory-calculator jvmkill auto-reconfiguration redis-store) %>

<% tomcat_based_resource_names = %w(tomcat-7 tomcat-8.0 tomcat-8.5) %>

<% wildcard_git_repos = maven_based_resource_names + artifactory_based_resource_names + %w(wildfly google-stackdriver-debugger-trusty client-certificate-mapper container-security-provider metric-writer) %>

resources:

 ## Git Repos ##

# Note: When testing different branches, you probably want to set
# `java-buildpack-dependency-builder-git-branch` in ci/public-config.yml for
# every resource that refers to `java-buildpack-dependency-builder-git-uri`.
# Multiple resources for this URL are used to trigger on specific build
# scripts.
- name: ci
  type: git
  source:
    uri: {{java-buildpack-dependency-builder-git-uri}}
    private_key: {{github-private-key}}
    branch: {{java-buildpack-dependency-builder-git-branch}}

- name: resources
  type: git
  source:
    uri: {{java-buildpack-dependency-builder-git-uri}}
    private_key: {{github-private-key}}
    branch: {{java-buildpack-dependency-builder-git-branch}}
    paths:
    - resources/**

- name: java-buildpack-dependency-builder-docker-image
  type: git
  source:
    uri: {{java-buildpack-dependency-builder-git-uri}}
    private_key: {{github-private-key}}
    branch: {{java-buildpack-dependency-builder-git-branch}}
    paths:
    - java-buildpack-dependency-builder/Dockerfile

- name: openjdk-docker-image
  type: git
  source:
    uri: {{java-buildpack-dependency-builder-git-uri}}
    private_key: {{github-private-key}}
    branch: {{java-buildpack-dependency-builder-git-branch}}
    paths:
    - openjdk/Dockerfile

- name: google-stackdriver-debugger-docker-image
  type: git
  source:
    uri: {{java-buildpack-dependency-builder-git-uri}}
    private_key: {{github-private-key}}
    branch: {{java-buildpack-dependency-builder-git-branch}}
    paths:
    - google-stackdriver-debugger/Dockerfile

- name: java-buildpack-client-certificate-mapper
  type: git
  source:
    uri: https://github.com/SUSE/cf-java-buildpack-client-certificate-mapper.git
    private_key: {{github-private-key}}
    branch: release

- name: client-certificate-mapper-archives
  type: s3
  source:
    bucket: suse-cf-java-buildpack
    regexp: client-certificate-mapper-archives/java-buildpack-client-certificate-mapper-(.*).jar
    access_key_id: {{aws-access-key}}
    secret_access_key: {{aws-secret-key}}

- name: java-buildpack-security-provider
  type: git
  source:
    uri: https://github.com/SUSE/cf-java-buildpack-security-provider.git
    private_key: {{github-private-key}}
    branch: release

- name: container-security-provider-archives
  type: s3
  source:
    bucket: suse-cf-java-buildpack
    regexp: container-security-provider-archives/java-buildpack-container-security-provider-(.*).jar
    access_key_id: {{aws-access-key}}
    secret_access_key: {{aws-secret-key}}

- name: java-buildpack-metric-writer
  type: git
  source:
    uri: https://github.com/SUSE/cf-java-buildpack-metric-writer.git
    private_key: {{github-private-key}}
    branch: release

- name: metric-writer-archives
  type: s3
  source:
    bucket: suse-cf-java-buildpack
    regexp: metric-writer-archives/java-buildpack-metric-writer-(.*).jar
    access_key_id: {{aws-access-key}}
    secret_access_key: {{aws-secret-key}}

- name: openjdk
  type: git
  source:
    uri: {{java-buildpack-dependency-builder-git-uri}}
    private_key: {{github-private-key}}
    branch: {{java-buildpack-dependency-builder-git-branch}}
    paths:
    - openjdk*

- name: tomcat
  type: git
  source:
    uri: {{java-buildpack-dependency-builder-git-uri}}
    private_key: {{github-private-key}}
    branch: {{java-buildpack-dependency-builder-git-branch}}
    paths:
    - tomcat.*

- name: tomcat-7-archives
  type: tomcat-resource
  source:
    uri: https://archive.apache.org/dist/tomcat/tomcat-7

- name: tomcat-8.0-archives
  type: tomcat-resource
  source:
    uri: https://archive.apache.org/dist/tomcat/tomcat-8
    version_pattern: (8\.0\..+)

- name: tomcat-8.5-archives
  type: tomcat-resource
  source:
    uri: https://archive.apache.org/dist/tomcat/tomcat-8
    version_pattern: (8\.5\..+)

<% wildcard_git_repos.each do |repo| %>
- name: <%= repo %>
  type: git
  source:
    uri: {{java-buildpack-dependency-builder-git-uri}}
    private_key: {{github-private-key}}
    branch: {{java-buildpack-dependency-builder-git-branch}}
    paths:
    - <%= repo %>*
<% end %>

- name: groovy-archives
  type: maven-resource
  source:
    uri: https://dl.bintray.com/groovy/maven
    artifact_id: groovy-binary
    group_id: org.codehaus.groovy
    packaging: zip
    version_pattern: (2\.4\..+)

- name: tomee-archives
  type: maven-resource
  source:
    uri: http://repo.maven.apache.org/maven2
    artifact_id: apache-tomee
    group_id: org.apache.tomee
    packaging: tar.gz
    classifier: webprofile

- name: wildfly-archives
  type: wildfly-resource

- name: java-archives
  type: java-resource
  source:
    uri: http://www.oracle.com/technetwork/java/javase/8u-relnotes-2225394.html
    version_pattern: (\d)\.(\d)\.0_(\d{1,3})-b(\d{1,3})

- name: mariadb-jdbc-archives
  type: maven-resource
  source:
    uri: https://repo1.maven.org/maven2
    artifact_id: mariadb-java-client
    group_id: org.mariadb.jdbc
    packaging: jar
    version_pattern: (2\.2\..+)

- name: postgresql-jdbc-archives
  type: maven-resource
  source:
    uri: https://repo1.maven.org/maven2
    artifact_id: postgresql
    group_id: org.postgresql
    packaging: jar
    version_pattern: (9\.4\..+)

- name: spring-boot-cli-archives
  type: maven-resource
  source:
    uri: https://repo.spring.io/release
    artifact_id: spring-boot-cli
    group_id: org.springframework.boot
    packaging: tar.gz
    classifier: bin

- name: tomcat-access-logging-support-archives
  type: maven-resource
  source:
    uri: https://maven.springframework.org/release
    artifact_id: tomcat-access-logging-support
    group_id: org.cloudfoundry
    packaging: jar

- name: tomcat-lifecycle-support-archives
  type: maven-resource
  source:
    uri: https://maven.springframework.org/release
    artifact_id: tomcat-lifecycle-support
    group_id: org.cloudfoundry
    packaging: jar

- name: tomee-resource-configuration-archives
  type: maven-resource
  source:
    uri: https://maven.springframework.org/release
    artifact_id: tomee-resource-configuration
    group_id: org.cloudfoundry
    packaging: jar

- name: tomcat-logging-support-archives
  type: maven-resource
  source:
    uri: https://maven.springframework.org/release
    artifact_id: tomcat-logging-support
    group_id: org.cloudfoundry
    packaging: jar

- name: container-customizer-archives
  type: maven-resource
  source:
    uri: https://repo.spring.io/release
    artifact_id: java-buildpack-container-customizer
    group_id: org.cloudfoundry
    packaging: jar

- name: memory-calculator-archives
  type: artifactory-resource
  source:
    uri: https://repo.spring.io
    artifact_id: java-buildpack-memory-calculator
    group_id: org.cloudfoundry
    repository: libs-release-local

- name: jvmkill-archives
  type: artifactory-resource
  source:
    uri: https://repo.spring.io
    artifact_id: jvmkill
    group_id: org.cloudfoundry
    repository: libs-release-local

- name: auto-reconfiguration-archives
  type: artifactory-resource
  source:
    uri: https://repo.spring.io
    artifact_id: java-buildpack-auto-reconfiguration
    group_id: org.cloudfoundry
    repository: libs-release-local

- name: redis-store-archives
  type: artifactory-resource
  source:
    uri: https://repo.spring.io
    artifact_id: redis-store
    group_id: com.gopivotal.manager
    repository: libs-release-local

- name: cloud-debug-java
  type: git
  source:
    uri: https://github.com/GoogleCloudPlatform/cloud-debug-java
    tag_filter: v2.16

 ## Docker Images ##

- name: openjdk-8-jre-alpine
  type: docker-image
  source:
    repository: openjdk
    tag: 8-jre-alpine

- name: alpine-latest
  type: docker-image
  source:
    repository: alpine

- name: cflinuxfs2-latest
  type: docker-image
  source:
    repository: cloudfoundry/cflinuxfs2

- name: ubuntu-trusty
  type: docker-image
  source:
    repository: ubuntu
    tag: latest

- name: java-buildpack-dependency-builder-latest
  type: docker-image
  source:
    repository: splatform/java-buildpack-dependency-builder
    username: {{docker-username}}
    password: {{docker-password}}

- name: openjdk-latest
  type: docker-image
  source:
    repository: splatform/openjdk
    username: {{docker-username}}
    password: {{docker-password}}

- name: google-stackdriver-debugger-latest
  type: docker-image
  source:
    repository: splatform/google-stackdriver-debugger
    username: {{docker-username}}
    password: {{docker-password}}

<% resource_names.each do |resource| %>
- name: <%= resource %>-resource-latest
  type: docker-image
  source:
    repository: splatform/<%= resource %>-resource
    username: {{docker-username}}
    password: {{docker-password}}
<% end %>

groups:
- name: docker
  jobs:
  - resource-docker-images
  - java-buildpack-dependency-builder-docker-image
  - openjdk-docker-image
  - google-stackdriver-debugger-docker-image
  - client-certificate-mapper-archives
  - container-security-provider-archives
  - metric-writer-archives
- name: java-buildpack-dependency-builder
  jobs:
  - tomcat-7
  - tomcat-8.0
  - tomcat-8.5
  - openjdk-trusty
  - google-stackdriver-debugger-trusty
  - tomee
  - groovy
  - jvmkill
  - wildfly
  - redis-store
  - mariadb-jdbc
  - postgresql-jdbc
  - spring-boot-cli
  - memory-calculator
  - auto-reconfiguration
  - container-customizer
  - tomcat-logging-support
  - tomcat-lifecycle-support
  - tomee-resource-configuration
  - tomcat-access-logging-support
  - client-certificate-mapper
  - container-security-provider
  - metric-writer

jobs:
- name: resource-docker-images
  plan:
  - aggregate:
    - resource: resources
      get: java-buildpack-dependency-builder
      trigger: true
    - get: openjdk-8-jre-alpine
      trigger: true
  - do:
    - task: build
      file: java-buildpack-dependency-builder/resources/ci/build.yml

<% resource_names.each do |resource| %>
    - put: <%= resource %>-resource-latest
      params:
        build: <%= resource %>-resource-docker-image
<% end %>

- name: java-buildpack-dependency-builder-docker-image
  plan:
  - aggregate:
    - get: java-buildpack-dependency-builder-docker-image
      trigger: true
    - get: alpine-latest
      trigger: true
  - do:
    - put: java-buildpack-dependency-builder-latest
      params:
        build: java-buildpack-dependency-builder-docker-image/java-buildpack-dependency-builder
      get_params:
        skip_download: true

- name: openjdk-docker-image
  plan:
  - aggregate:
    - get: openjdk-docker-image
      trigger: true
    - get: ubuntu-trusty
      trigger: true
  - do:
    - put: openjdk-latest
      params:
        build: openjdk-docker-image/openjdk
      get_params:
        skip_download: true

- name: google-stackdriver-debugger-docker-image
  plan:
  - aggregate:
    - get: google-stackdriver-debugger-docker-image
      trigger: true
    - get: cflinuxfs2-latest
      trigger: true
  - do:
    - put: google-stackdriver-debugger-latest
      params:
        build: google-stackdriver-debugger-docker-image/google-stackdriver-debugger
      get_params:
        skip_download: true

- name: openjdk-trusty
  plan:
  - aggregate:
    - resource: openjdk
      get: java-buildpack-dependency-builder
      trigger: true
    - get: ci
    - get: java-archives
  - do:
    - task: build
      file: java-buildpack-dependency-builder/openjdk-trusty.yml
      params:
        S3_BUCKET: suse-cf-java-buildpack
        AWS_ACCESS_KEY_ID: {{aws-access-key}}
        AWS_SECRET_ACCESS_KEY: {{aws-secret-key}}
        AWS_ENDPOINT: https://s3.amazonaws.com
        DOWNLOAD_DOMAIN: s3.amazonaws.com/suse-cf-java-buildpack
        SOURCES_EXPORT_DIR: source-artifacts/
    - task: push-sources
      file: ci/ci/tasks/push-sources-to-obs.yml
      params:
        OBS_USERNAME:  {{obs-username}}
        OBS_PASSWORD:  {{obs-password}}
        PROJECT:       Cloud:Platform:sources:buildpacks
- name: tomcat-7
  plan:
  - aggregate:
    - resource: tomcat
      get: java-buildpack-dependency-builder
      trigger: true
    - resource: tomcat-7-archives
      trigger: true
      get: tomcat-archives
    - get: ci
  - do:
    - task: build
      file: java-buildpack-dependency-builder/tomcat.yml
      params:
        S3_BUCKET: suse-cf-java-buildpack
        AWS_ACCESS_KEY_ID: {{aws-access-key}}
        AWS_SECRET_ACCESS_KEY: {{aws-secret-key}}
        AWS_ENDPOINT: https://s3.amazonaws.com
        DOWNLOAD_DOMAIN: s3.amazonaws.com/suse-cf-java-buildpack
        SOURCES_EXPORT_DIR: source-artifacts/
    - task: push-sources
      file: ci/ci/tasks/push-sources-to-obs.yml
      params:
        OBS_USERNAME:  {{obs-username}}
        OBS_PASSWORD:  {{obs-password}}
        PROJECT:       Cloud:Platform:sources:buildpacks
- name: tomcat-8.0
  plan:
  - aggregate:
    - resource: tomcat
      get: java-buildpack-dependency-builder
      trigger: true
    - resource: tomcat-8.0-archives
      trigger: true
      get: tomcat-archives
    - get: ci
  - do:
    - task: build
      file: java-buildpack-dependency-builder/tomcat.yml
      params:
        S3_BUCKET: suse-cf-java-buildpack
        AWS_ACCESS_KEY_ID: {{aws-access-key}}
        AWS_SECRET_ACCESS_KEY: {{aws-secret-key}}
        AWS_ENDPOINT: https://s3.amazonaws.com
        DOWNLOAD_DOMAIN: s3.amazonaws.com/suse-cf-java-buildpack
        SOURCES_EXPORT_DIR: source-artifacts/
    - task: push-sources
      file: ci/ci/tasks/push-sources-to-obs.yml
      params:
        OBS_USERNAME:  {{obs-username}}
        OBS_PASSWORD:  {{obs-password}}
        PROJECT:       Cloud:Platform:sources:buildpacks
- name: tomcat-8.5
  plan:
  - aggregate:
    - resource: tomcat
      get: java-buildpack-dependency-builder
      trigger: true
    - resource: tomcat-8.5-archives
      trigger: true
      get: tomcat-archives
    - get: ci
  - do:
    - task: build
      file: java-buildpack-dependency-builder/tomcat.yml
      params:
        S3_BUCKET: suse-cf-java-buildpack
        AWS_ACCESS_KEY_ID: {{aws-access-key}}
        AWS_SECRET_ACCESS_KEY: {{aws-secret-key}}
        AWS_ENDPOINT: https://s3.amazonaws.com
        DOWNLOAD_DOMAIN: s3.amazonaws.com/suse-cf-java-buildpack
        SOURCES_EXPORT_DIR: source-artifacts/
    - task: push-sources
      file: ci/ci/tasks/push-sources-to-obs.yml
      params:
        OBS_USERNAME:  {{obs-username}}
        OBS_PASSWORD:  {{obs-password}}
        PROJECT:       Cloud:Platform:sources:buildpacks

- name: google-stackdriver-debugger-trusty
  plan:
  - aggregate:
    - resource: google-stackdriver-debugger-trusty
      get: java-buildpack-dependency-builder
      trigger: true
    - get: cloud-debug-java
      trigger: true
    - get: ci
  - do:
    - task: build
      file: java-buildpack-dependency-builder/google-stackdriver-debugger-trusty.yml
      params:
        S3_BUCKET: suse-cf-java-buildpack
        AWS_ACCESS_KEY_ID: {{aws-access-key}}
        AWS_SECRET_ACCESS_KEY: {{aws-secret-key}}
        AWS_ENDPOINT: https://s3.amazonaws.com
        DOWNLOAD_DOMAIN: s3.amazonaws.com/suse-cf-java-buildpack
        SOURCES_EXPORT_DIR: source-artifacts/
    - task: push-sources
      file: ci/ci/tasks/push-sources-to-obs.yml
      params:
        OBS_USERNAME:  {{obs-username}}
        OBS_PASSWORD:  {{obs-password}}
        PROJECT:       Cloud:Platform:sources:buildpacks

- name: client-certificate-mapper-archives
  plan:
  - aggregate:
    - get: java-buildpack-client-certificate-mapper
      trigger: true
  - do:
    - task: build
      file: java-buildpack-client-certificate-mapper/ci/deploy.yml
    - put: client-certificate-mapper-archives
      params:
        file: output/java-buildpack-client-certificate-mapper-*.jar
        acl: public-read

- name: container-security-provider-archives
  plan:
  - aggregate:
    - get: java-buildpack-security-provider
      trigger: true
  - do:
    - task: build
      file: java-buildpack-security-provider/ci/deploy.yml
    - put: container-security-provider-archives
      params:
        file: output/java-buildpack-container-security-provider-*.jar
        acl: public-read

- name: metric-writer-archives
  plan:
  - aggregate:
    - get: java-buildpack-metric-writer
      trigger: true
  - do:
    - task: build
      file: java-buildpack-metric-writer/ci/deploy.yml
    - put: metric-writer-archives
      params:
        file: output/java-buildpack-metric-writer-*.jar
        acl: public-read

<% (wildcard_git_repos - %w(google-stackdriver-debugger-trusty)).each do |resource| %>
- name: <%= resource %>
  plan:
  - aggregate:
    - resource: <%= resource %>
      get: java-buildpack-dependency-builder
      trigger: true
    - get: <%= resource %>-archives
      trigger: true
    - get: ci
  - do:
    - task: build
      file: java-buildpack-dependency-builder/<%= resource %>.yml
      params:
        S3_BUCKET: suse-cf-java-buildpack
        AWS_ACCESS_KEY_ID: {{aws-access-key}}
        AWS_SECRET_ACCESS_KEY: {{aws-secret-key}}
        AWS_ENDPOINT: https://s3.amazonaws.com
        DOWNLOAD_DOMAIN: s3.amazonaws.com/suse-cf-java-buildpack
        SOURCES_EXPORT_DIR: source-artifacts/
    - task: push-sources
      file: ci/ci/tasks/push-sources-to-obs.yml
      params:
        OBS_USERNAME:  {{obs-username}}
        OBS_PASSWORD:  {{obs-password}}
        PROJECT:       Cloud:Platform:sources:buildpacks
<% end %>

